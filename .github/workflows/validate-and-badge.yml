name: Validate & Badge Milestones

on:
  workflow_dispatch:
  push:
    paths:
      - "milestones/**"
      - ".github/schema/**"
      - "scripts/**"

jobs:
  validate:
    name: "1️⃣ Validate milestones.json"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install jsonschema
        run: pip install jsonschema

      - name: Run validation
        run: |
          python - <<PYCODE
          import json, jsonschema, sys
          schema = json.load(open(".github/schema/milestones.schema.json"))
          data   = json.load(open("milestones/milestones.json"))
          jsonschema.validate(instance=data, schema=schema)
          print("✅ milestones.json is valid")
          PYCODE

  badges:
    name: "2️⃣ Generate SVG badges"
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install badge-maker
        run: npm install --no-save badge-maker

      - name: Generate badges
        run: node scripts/generate-badges.js

      - name: Commit badges
        uses: EndBug/add-and-commit@v9
        with:
          author_name: "GhostOps Bot"
          author_email: "noreply@github.com"
          message: "chore: update milestone badges"
          add: "badges/*.svg"
